<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.32.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.0.1/mapbox-gl-geocoder.js'></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-92988185-1', 'auto');
      ga('send', 'pageview');
    </script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.32.1/mapbox-gl.css' />
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.0.1/mapbox-gl-geocoder.css' type='text/css' />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet">
    <style>
        body {
          margin:0;
          padding:0;
          background-color: #087fcb;
          font-family: 'Roboto', sans-serif;
        }

        h1, h2, p, div {
          font-family: 'Roboto', sans-serif;
        }

        #app {
          /*background-color: rgb(193, 193, 193);*/
          background-color: #087fcb;
          padding: 0;
          width: 100%;
        }

        #app img {
          width: auto;
          max-height: 100px;
          height: 10vh;
        }

        #app h1 {
          color: #FFF;
          font-size: 10px;
          font-size: 2.7vw;
          font-weight: normal;
        }

        #map img {
         max-width: none;
         min-width: 0px;
        }
        #map {
          height: 600px;
          height: 88vh;
        }

        #moreinfo {
          background-color: white;
        }

        #menu {
            background: #fff;
            position: absolute;
            z-index: 1;
            top: 10px;
            left: 25px;
            border-radius: 3px;
            width: 140px;
            border: 1px solid rgba(0,0,0,0.4);
            /*font-family: 'Open Sans', sans-serif;*/
            margin-top: 10vh;
        }

        #menu a {
            font-size: 13px;
            color: #404040;
            display: block;
            margin: 0;
            padding: 0;
            padding: 10px;
            text-decoration: none;
            border-bottom: 1px solid rgba(0,0,0,0.25);
            text-align: center;
        }

        #menu a:last-child {
            border: none;
        }

        #menu a:hover {
            background-color: #f8f8f8;
            color: #404040;
        }

        #menu a.active {
          background-color: #3887be;
          color: #ffffff;
        }

        #menu a.active:hover {
            background: #3074a4;
        }

        #menu a:after {
            content: '';
            display: block;
            clear: both;
        }

        #feedback {
          float: right;
          margin: 0 1vw;
        }

        .overlay {
          position:absolute;
          top:0;
          left:0;
          right:0;
          bottom:0;
          background-color:rgba(0, 0, 0, 0.75);
          z-index:9999;
          color:white;
          text-align: center;
          display: none;
        }

        .overlay:before {
            content: '';
            display: inline-block;
            height: 100%;
            vertical-align: middle;
            margin-right: -0.25em;
        }

        .feedback_container {
            display: inline-block;
            vertical-align: middle;
            padding: 10px 15px;
            position:relative;
            font-weight:bold;
            background-color: #FFF;
            color: #000;
            border-radius: 5px;
        }

        .feedback_container input {
          display: block;
          margin: 5px 0px;
        }

        .feedback_container label {
          display: block;
          text-align: left;
          position: relative;
        }

        #overlay_close {
          width: 30px;
          position: absolute;
          top: -15px;
          right: -15px;
          cursor: pointer;
        }

        .navbar {
          min-height: 0;
        }

        .face {
          max-width: 30px;
        }

        #smile {
          float: right;
        }

        #frown {
          float: left;
        }

        .outlet {
          width: 50%;
          margin: 0;
          display: inline-block;
        }

        .legend-key {
          display: block;
          float: left;
          width: 15px;
          height: 15px;
        }

        .legend-text {
          display: block;
          /*float: left;*/
          padding: 0px 5px;
          margin: 0;
        }

        textarea {
          width: 300px;
        }

        #menu #collapse {
          display: none;
          padding: 7px;
        }

        #collapse img {
          width: 25px;
        }

        @media (max-width: 550px) {
          #app .subtitle {
            display: none;
          }
          #app h1 {
            font-size: 5vw;
          }
          textarea {
            width: 150px;
          }
          #menu {
            width: 120px;
            left: 20px;
          }
          #menu #collapse {
            display: block;
          }
          #menu .layer {
            display: none;
          }
          #map .mapboxgl-ctrl-geocoder {
            min-width: 150px;
          }
        }

    </style>
 </script>
</head>
<body>
<style>
  .mapboxgl-popup {
      max-width: 400px;
      font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
  }
</style>

<div class="navbar navbar-fixed-top">
  <div class="col-sm-2 col-md-3"></div>
  <div id="menu">
    <a href="#" id="collapse" class="active"><img src="plus.png" alt=""></a>
  </div>
</div>

<div class="container" id="app">
    <img class="col-xs-12" src="logo.png">
    <h1>Property Buddy<span class="subtitle"> - what you need to know before buying...</span>
      <button type="submit" class="btn btn-success" id="feedback">Feedback!</button>
    </h1>
    <div class="col-xs-12">
      <div id="map"></div>
    </div>
</div>

<div class="overlay" id="overlay">
  <div class="feedback_container" id="feedback_container">
    <p>Please give us your feedback...</p>
    <img src="cross.png" id="overlay_close">
    <form action="https://formspree.io/thepropertybuddy@gmail.com" method="POST">
        <div class="form-group">
          <label for="name">Name</label>
          <input type="text" name="name" class="form-control">
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" name="_replyto" class="form-control">
        </div>
        <div class="form-group">
          <label for="Phone Number">Phone</label>
          <input type="text" name="phone" class="form-control">
        </div>
        <div class="form-group">
          <label for="feedback">Feedback</label>
          <textarea name="feedback" rows="5"></textarea>
        </div>
        <div class="form-group">
          <label for="pay">How much might you pay for this product?</label>
          <input type="range" name="pay" value="0" min="0" max="200" step="1" oninput="updatePay(value)">
          <img src="frown.png" id="frown" class="face">
          <output for="pay" id="pay_value" class="outlet">$0 per month</output>
          <img src="smile.png" id="smile" class="face">
        </div>
        <button type="submit" class="btn btn-default" id="feedback_submit">Submit</button>
    </form>
  </div>
</div>

<div class="modal fade" id="dataModal" tabindex="-1" role="dialog" aria-labelledby="dataModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="dataModalLabel">Detailed Information</h4>
      </div>
      <div class="modal-body">
        <div id="pointData"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script>

function updatePay(value) {
	document.querySelector('#pay_value').value = "$" + value + " per month";
}

$("#feedback").click(function(event) {
  event.preventDefault();
  $("#overlay").fadeToggle("fast");
});

$("#overlay, #overlay_close").click(function(event){
  event.preventDefault();
  $("#overlay").fadeToggle("fast");
});

$("#feedback_container").click(function(event) {
  event.stopPropagation();
})

mapboxgl.accessToken = 'pk.eyJ1IjoibG13cmlnaHQ4OSIsImEiOiJjaXp2MmI5bm8wMHB2MnduaDdkcWV0OWV0In0.yVDv6j4s-4f11Lhu-EQw1w';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/lmwright89/cj010vmhg007n2smm4gesq1mg',
    zoom: 14,
    center: [153.037,-27.493]
});

map.addControl(new MapboxGeocoder({
  accessToken: mapboxgl.accessToken,
  country: 'AU'
}), 'top-right');

map.addControl(new mapboxgl.GeolocateControl({
    positionOptions: {
        enableHighAccuracy: true
    }
}), 'top-right');

map.addControl(new mapboxgl.NavigationControl({}), 'top-right');

map.addControl(new mapboxgl.ScaleControl(), 'bottom-right');

var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
});

var toggleableLayers = [
  ['Crime Data', 'visible'],
  ['Heritage', 'visible'],
  ['Master Plan', 'visible'],
  ['Proposed Construction', 'none'],
  ['Approved Construction', 'none'],
  ['Under Construction', 'none'],
  ['River Flood', 'none'],
  ['3D Buildings', 'none'],
  // ['Public Transport', 'none'],
  ['Sewerage', 'none'],
  ['Zoning', 'none'],
];
var toggleableLayerIds = toggleableLayers.map(function(p) { return p[0]; });

map.on('click', function(e) {
  showModal(e.point);
});

function showModal(point) {
  var features = map.queryRenderedFeatures(point, {
    layers: toggleableLayerIds
  });

  if (features.length) {
      $('#pointData').html('');
      features.forEach(function(f) {
        if (f.layer.id === 'Master Plan') {
          var html = "<h3>Master Plan</h3>";
          var description = f.properties['Description'];
          var regex = /(<([^>]+)>)/ig;
          description = description.replace(regex, "\n");

          var regex = /^([\s\w]+): (.*)/igm;
          var match = regex.exec(description);
          while (match != null) {
            // matched text: match[0]
            // match start: match.index
            // capturing group n: match[n]
            var key = match[1];
            var value = match[2];
            if (key && value) {
              html += '<b>'+key+':</b> ' + value + '<br>';
              //console.log(key + ' ==> ' + value);
            }
            match = regex.exec(description);
          }
          $('#pointData').append(html);
        } else {
          var html = "<pre>";
          html += f.layer.id + '\n';
          var json = JSON.stringify(f.properties, null, '  ');
          var regex = /(<([^>]+)>)/ig;
          json = json.replace(regex, "");

          html += json + '</pre>\n';
          $('#pointData').append(html);
        }
      })
      $('#dataModal').modal('show');
  }
}

map.on('mousemove', function(e) {
    var features = map.queryRenderedFeatures(e.point, {
      layers: toggleableLayerIds
    });
    // Change the cursor style as a UI indicator.
    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

    if (!features.length) {
      popup.remove();
      return;
    }

    var feature = features[0];

  var popupHtml = '<a href="javascript:showModal(e.point)">' + feature.layer.id + '</a>';

  popup.setLngLat(e.lngLat)
    .setHTML(popupHtml)
    .addTo(map);
});

map.on('load', function(){
  map.addLayer({
          'id': '3D Buildings',
          'source': 'composite',
          'source-layer': 'building',
          'filter': ['==', 'extrude', 'true'],
          'type': 'fill-extrusion',
          'minzoom': 15,
          'paint': {
              'fill-extrusion-color': '#aaa',
              'fill-extrusion-height': {
                  'type': 'identity',
                  'property': 'height'
              },
              'fill-extrusion-base': {
                  'type': 'identity',
                  'property': 'min_height'
              },
              'fill-extrusion-opacity': .6
          }
      });

  for (var i = 0; i < toggleableLayers.length; i++) {
      var layerId = toggleableLayers[i][0];
      var defaultState = toggleableLayers[i][1];

      var link = document.createElement('a');
      link.href = '#';
      link.className = 'active layer';
      link.id = layerId;

      var text = document.createElement('p');
      text.textContent = layerId;
      text.className = 'legend-text';

      //Legend colours
      var color = map.getPaintProperty(layerId, 'fill-color');
      if (!color) color = map.getPaintProperty(layerId, 'circle-color');
      if (!color) color = map.getPaintProperty(layerId, 'line-color');
      if (!color) color = map.getPaintProperty(layerId, 'fill-extrusion-color');
      color = color.replace(/[\d\.]+\)$/g, '1)');
      var key = document.createElement('span');
      key.className = 'legend-key';
      key.style.backgroundColor = color;

      //Legend Icon
      //better way to test for circles?
      if (map.getPaintProperty(layerId, 'circle-color')) {
        key.style.borderRadius = "15px";
      }

      link.onclick = function (e) {
          var clickedLayer = this.id;
          e.preventDefault();
          e.stopPropagation();

          setLayerVisibility(this, clickedLayer);
      };

      setLayerVisibility(link, layerId, defaultState);

      var layers = document.getElementById('menu');
      link.appendChild(key);
      link.appendChild(text);
      layers.appendChild(link);
  }
});

function setLayerVisibility(link, clickedLayer, defaultState) {
  var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

  if (defaultState === 'visible') {
    visibility = 'none';
  } else if (defaultState === 'none') {
    visibility = 'visible'
  }

  if (visibility === 'visible') {
      map.setLayoutProperty(clickedLayer, 'visibility', 'none');
      link.className = 'layer';
  } else {
      link.className = 'active layer';
      map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
  }
}

$("#collapse").click(function(){
  if ($("#collapse img").attr("src") == "plus.png") {
    $("#menu .layer").css("display", "block");
    $("#collapse img").attr("src", "minus.png");
  } else {
    $("#menu .layer").css("display", "none");
    $("#collapse img").attr("src", "plus.png");
  }
});

/*
if (window.location.href == "https://propertybuddy.github.io/") {
  setTimeout(function() {
    $("#overlay").fadeIn();
  }, 13000);
}
*/

</script>

</body>
</html>
